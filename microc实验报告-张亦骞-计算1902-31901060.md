# [2021-2022学年第2学期](https://plc-sigcc.vercel.app/#/lab/proj.final?id=_2020-2021学年第2学期)

# [**实 验 报 告**](https://plc-sigcc.vercel.app/#/lab/proj.final?id=实-验-报-告)

![zucc](https://plc-sigcc.vercel.app/lab/zucc.png)

- 课程名称:编程语言原理与编译
- 实验项目:期末大作业
- 专业班级<u>计算1902</u>
- 学生学号<u>31901060</u>
- 学生姓名<u>张亦骞</u>
- 实验指导教师:郭鸣

## [实验内容](https://plc-sigcc.vercel.app/#/lab/proj.final?id=实验内容)

1. 评分方式，以下为起始评分

   - 按 及格 中 良 优 参考计分，最终看完成水平。

     ```
     60 70 80 90
     ```

     - [参考任务](https://gitee.com/sigcc/plzoofs/blob/master/microc/task.md)

   - 优秀

     - 参与实际的开源编译器项目
       - v rust julia 等
     - 自行完整实现一个较复杂的语言
       - 生成 中间语言、汇编
       - 实现高级的语言特性
         - 按特性实现难度给分

   - 良 完整实现一个简单语言

     - 词法/语法/语义检查，中间代码IR,栈式虚拟机

   - 中 实现一个简单语言

     - 实现 词法/语法/语义（类型检查，中间语言AST,IR）

   - 及格 修改实现一个简单语言

     - 修改 现有项目 简单的词法/语法，必须理解原来的代码
     - 实现需要包括解释器和编译器

2. 完成文档为 md格式，请预览并确保格式正确。

   - 缩进，代码，图片，突出显示 的正确markdown语法
   - 翻译专业词汇标准，请到图书馆查找相关翻译的编译书籍，部分书籍有专业术语表。
     - columbia
     - PLC
     - ssw
     - yale

3. 提交内容

   - 项目报告
     - 文档结构 [参考项目结构](https://bb.zucc.edu.cn/bbcswebdav/users/j04014/PLC/final/columbia.microc.llvm.proj.rar)
   - 项目源代码（测试代码）
   - [参考项目](https://bb.zucc.edu.cn/bbcswebdav/users/j04014/PLC/final21)

4. 建议改进列表（可选择其中部分加以改进）

   - 词法部分
     - 修改注释的表示方式，如：
       - (* *)
       - //
       - /* */
     - 修改常量定义
       - 字符串常量 （参考python语法）
         - 单引号' ' 双引号 "" 三引号 '''
       - 数值常量 （参考c语法）
         - 二进制 0b0101，八进制0o777，十六进制0xFFDA
     - 修改标识符定义
       - 类型名称：以大写开头
       - 变量名：以小写开头
       - 两个下划线开头的名字__是内部保留，不允许
   - 语法部分
     - if的多种方式
       - switch case
     - 循环的多种方式
       - for / while / do while/ until
     - ? : 表达式 (C语言)
     - for in 表达式
     - 匿名 lambda 函数（参考Python 或 Javascript）
   - 语义部分
     - 类型检查，类型推理
     - 支持嵌套函数
     - 动态作用域，静态作用域
     - 闭包支持
     - 模式匹配支持
     - 中间代码生成 AST，四元式，三元式，llvm
     - 生成器 generator, yield
     - 协程 coroutine

5. 其他参考实现语言项目

   - 命令式语言 NanoC
   - 对象式语言 NanoJ
   - 函数式语言 NanoF
   - 逻辑式语言 NanoL

6. 项目分工表格

| 姓名   | 学号     | 班级     | 任务       | 权重 |
| ------ | -------- | -------- | ---------- | ---- |
| 蔡海龙 | 31901039 | 计算1902 |            | 0.95 |
| 张亦骞 | 31901060 | 计算1902 | 自增自减， | 0.95 |

7. 成员代码提交日志：

![提交信息](https://plc-sigcc.vercel.app/lab/commit.png)

1. 项目自评等级:(1-5) 请根据自己项目情况填写下表

| 词法                                               | 评分（打⭐）     | 备注     |
| -------------------------------------------------- | --------------- | -------- |
| 注释 (* *)                                         |                 |          |
| 注释 /**/                                          |                 |          |
| 注释 //                                            |                 |          |
| 字符串常量 单引号' '                               |                 |          |
| 字符串常量 双引号 ""                               |                 |          |
| 字符串常量 三引号 '''                              |                 |          |
| 数值常量 二进制0b0101                              |                 |          |
| 数值常量 八进制0o777                               |                 |          |
| 数值常量 十六0xFFDA                                |                 |          |
| 修改标识符定义 类型名称：以大写开头                |                 |          |
| 修改标识符定义 变量名：以小写开头                  |                 |          |
| 修改标识符定义  __不可作为变量名开头（遇到则报错） |                 |          |
|                                                    |                 |          |
| **语法**                                           | **评分（打⭐）** | **备注** |
| 变量初始化（定义变量时同时赋初值）                 |                 |          |
| if的多种方式                                       |                 |          |
| switch case                                        |                 |          |
| 循环 for                                           |                 |          |
| 循环 while                                         |                 |          |
| 循环 do while                                      |                 |          |
| 循环 until                                         |                 |          |
| 三目运算 ? :      (C语言)                          |                 |          |
| for in 表达式                                      |                 |          |
| 匿名 lambda 函数（参考Python 或 Javascript）       |                 |          |
| 前置自增、前置自减                                 | ⭐⭐⭐⭐⭐           |          |
| 后置自增、后置自减                                 | ⭐⭐⭐⭐            |          |
|                                                    |                 |          |
| **变量类型**                                       | **评分（打⭐）** | **备注** |
| float类型                                          |                 |          |
| double类型                                         |                 |          |
| string类型                                         |                 |          |
| boolean类型                                        |                 |          |
|                                                    |                 |          |
| **语义**                                           | **评分（打⭐）** | **备注** |
| 动态作用域                                         |                 |          |
| 静态作用域                                         |                 |          |
| 闭包支持                                           |                 |          |
| 模式匹配支持                                       |                 |          |
| 中间代码生成 AST，四元式，三元式，llvm             |                 |          |
| 生成器 generator, yield                            |                 |          |
|                                                    |                 |          |

### **一、功能实现步骤（以前置自增为例）**

**解释器部分：**

（1）在Absyn.fs中定义抽象语法

```F#
and expr =                           // 表达式，右值                     
  | PreInc of access                                           //自增 ++i or ++a[e]
```

（2）在CPar.fsy中添加词元说明符token和该token的用法

添加词元说明符token：

```
//%token是词元说明符
...
%token PREINC           //前置自增
...
```

```F#
%right ASSIGN             /* 最低优先级 */  // 最下面的优先级最高
...
%left TIMES DIV MOD       //乘 除 取余
%nonassoc NOT AMP PREINC         //!取反 &取地址 前置自增
%nonassoc LBRACK          /* 最高优先级  */  //左括号

//这里要注意添加的关键字的优先级，优先级高的放下面，优先级低的放上面
```

添加用法：

```
  //非左值的情况
ExprNotAccess:
...
  | PREINC Access                       { PreInc $2      }  // 前置自增++a
...
;
```

（3）在CLex.fsl中添加该token

```F#
rule Token = parse          // 每个 规则rule 会生成为一个函数，函数名是规则名 Token
...
  | "++"            { PREINC }    //前置自增
...

//注意这里++要用双引号，不能用单引号
```

（4）在Interp.fs中添加该token的实现

```F#
and eval e locEnv gloEnv store : int * store =
    match e with
    ...
    | PreInc acc -> //前置自增
        let (loc, store1) as res = access acc locEnv gloEnv store //取要求的acc的地址和环境
        let res = getSto store1 loc //得到要求的这个acc在store1的loc位置上的值
        (res + 1, setSto store1 loc (res + 1)) //把值加一后set到store中，元组左边返回的就是这个加一后的值
    ...

```



**编译器部分：**

（1）在Absyn.fs中定义抽象语法【即解释器部分的（1）】

（2）若需要添加汇编指令，在Machine.c中添加【前置自增未用到新的指令，故省略该步骤】

（3）在Comp.fs中添加相应的实现

```F#
//编译右值表达式
and cExpr (e: expr) (varEnv: VarEnv) (funEnv: FunEnv) : instr list =
    match e with
	...
	| PreInc acc -> cAccess acc varEnv funEnv @ [ DUP; LDI; CSTI 1; ADD; STI ]//前置自增
	...
```



### **二、执行的命令**

**解释器部分（12条命令）：**

```sh
dotnet restore interpc.fsproj #可选
dotnet clean interpc.fsproj #可选
dotnet build -v n interpc.fsproj #构建./bin/Debug/net6.0/interpc.exe，并查看详细生成过程
./bin/Debug/net6.0/interpc.exe zyq_example/preinc.c #查看运行结果
dotnet "C:\Users\82444\.nuget\packages\fslexyacc\10.2.0\build\/fslex/netcoreapp3.1\fslex.dll" -o "CLex.fs" --module CLex --unicode CLex.fsl #生成扫描器
dotnet "C:\Users\82444\.nuget\packages\fslexyacc\10.2.0\build\/fsyacc/netcoreapp3.1\fsyacc.dll" -o "CPar.fs" --module CPar CPar.fsy #生成分析器
dotnet fsi #进入命令行
#注：以下代码在fsi中运行
#r "nuget: FsLexYacc";; //添加包引用
#load "Absyn.fs" "Debug.fs" "CPar.fs" "CLex.fs" "Parse.fs" "Interp.fs" "ParseAndRun.fs" ;;
open ParseAndRun;;
fromFile "zyq_example/preinc.c";; #查看preinc.c语法树
run (fromFile "zyq_example/preinc.c") [];; #解释执行preinc.c
```

**编译器部分（6条命令）：**

```sh
gcc -o machine.exe machine.c #生成c虚拟机
dotnet restore microc.fsproj #可选
dotnet clean microc.fsproj #可选
dotnet build microc.fsproj #构建./bin/Debug/net6.0/microc.exe
dotnet run --project microc.fsproj zyq_example/preinc.c
.\machine.exe -trace zyq_example/preinc.out 0 #追踪查看运行栈
```



### **三、项目说明**

- 项目是基于现有的microc代码

  - 改进 xxx模块 功能1

    

  - 开发 前置自增、前置自减

    解释器部分：

    （1）在Absyn.fs中

    ![1](/img/添加步骤示例/1.png)

    （2）在CPar.fsy中

    ![](/img/添加步骤示例/2.png)
  
    ![](/img/添加步骤示例/3.png)
  
    ![](/img/添加步骤示例/4.png)
  
    （3）在CLex.fsl中
  
    ![](/img/添加步骤示例/5.png)
  
    （4）在Interp.fs中
  
    ![](/img/添加步骤示例/6.png)
  
    ![](/img/添加步骤示例/7.png)
  
    （5）结果
  
    preinc：
  
    ```c
    //前置自增
    void main() {
      int x;
      x = 3;
      print x;
      ++x;
      print x;
    }
    ```
  
    preinc语法树：
  
    ![](/img/preinc/7.png)
  
    preinc解释运行：
  
    
  
    preinc追踪运行栈：
  
    
  
    
  
  - 开发 三目运算符
  
    
  
    
  
  - 开发 xxx模块 功能2
  
    

### **四、解决技术要点说明**

- 解决 xxx 问题， 关键代码与步骤如下
  - 
  - 
- 解决 xxx 问题2， 关键代码与步骤如下
  - 
  - 

### **五、心得体会（结合自己情况具体说明）**

- **大项目开发过程心得**

  - 遇到哪些困难，经历哪里过程，有哪些收获

    张亦骞：
    
    
    
    
    
    蔡海龙：
    
    
    
    

- **本课程建议**

  - 课程难度方面，进度方面，课程内容，授课方式等，给出你的意见

    张亦骞：
    
    
    
    
    
    蔡海龙：
    
    
    
    